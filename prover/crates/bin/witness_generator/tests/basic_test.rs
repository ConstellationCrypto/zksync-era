#![allow(incomplete_features)] // We have to use generic const exprs.
#![feature(generic_const_exprs)]

use std::{str::FromStr, time::Instant};

use serde::Serialize;
use zkevm_test_harness::{
    utils::snapshot_prof, zkevm_circuits::scheduler::aux::BaseLayerCircuitType,
};
use zksync_config::{configs::object_store::ObjectStoreMode, ObjectStoreConfig};
use zksync_object_store::ObjectStoreFactory;
use zksync_prover_dal::{ConnectionPool, Prover, ProverDal};
use zksync_prover_fri_types::{
    keys::{AggregationsKey, FriCircuitKey},
    CircuitWrapper,
};
use zksync_prover_fri_utils::get_recursive_layer_circuit_id_for_base_layer;
use zksync_types::{
    basic_fri_types::AggregationRound,
    prover_dal::{LeafAggregationJobMetadata, NodeAggregationJobMetadata},
    url::SensitiveUrl,
    L1BatchNumber,
};
use zksync_witness_generator::{
    basic_circuits::generate_witness,
    leaf_aggregation::{
        prepare_leaf_aggregation_job, save_artifacts, LeafAggregationWitnessGenerator,
    },
    node_aggregation::{
        self, save_artifacts as save_node_artifacts, NodeAggregationWitnessGenerator,
    },
    utils::AggregationWrapper,
};

fn compare_serialized<T: Serialize>(expected: &T, actual: &T) {
    let serialized_expected = bincode::serialize(expected).unwrap();
    let serialized_actual = bincode::serialize(actual).unwrap();
    assert_eq!(serialized_expected, serialized_actual);
}

#[tokio::test]
async fn test_leaf_witness_gen() {
    let circuit_id = 1;
    let block_number = L1BatchNumber(11027);

    let ids = vec![
        33866382, 33866383, 33866384, 33866385, 33866386, 33866387, 33866388, 33866389, 33866390,
        33866391, 33866392, 33866393, 33866394, 33866395, 33866396, 33866397, 33866398, 33866399,
        33866400, 33866401, 33866402, 33866403, 33866404, 33866405, 33866406, 33866407, 33866408,
        33866409, 33866410, 33866411, 33866412, 33866413, 33866414, 33866415, 33866416, 33866417,
        33866418, 33866419, 33866420, 33866421, 33866422, 33866423, 33866424, 33866425, 33866426,
        33866427, 33866428, 33866429, 33866430, 33866431, 33866432, 33866433, 33866434, 33866435,
        33866436, 33866437, 33866438, 33866439, 33866440, 33866441, 33866442, 33866443, 33866444,
        33866445, 33866446, 33866447, 33866448, 33866449, 33866450, 33866451, 33866452, 33866453,
        33866454, 33866455, 33866456, 33866457, 33866458, 33866459, 33866460, 33866461, 33866462,
        33866463, 33866464, 33866465, 33866466, 33866467, 33866468, 33866469, 33866470, 33866471,
        33866472, 33866473, 33866474, 33866475, 33866476, 33866477, 33866478, 33866479, 33866480,
        33866481, 33866482, 33866483, 33866484, 33866485, 33866486, 33866487, 33866488, 33866489,
        33866490, 33866491, 33866492, 33866493, 33866494, 33866495, 33866496, 33866497, 33866498,
        33866499, 33866500, 33866501, 33866502, 33866503, 33866504, 33866505, 33866506, 33866507,
        33866508, 33866509, 33866510, 33866511, 33866512, 33866513, 33866514, 33866515, 33866516,
        33866517, 33866518, 33866519, 33866520, 33866521, 33866522, 33866523, 33866524, 33866525,
        33866526, 33866527, 33866528, 33866529, 33866530, 33866531, 33866532, 33866533, 33866534,
        33866535, 33866536, 33866537, 33866538, 33866539, 33866540, 33866541, 33866542, 33866543,
        33866544, 33866545, 33866546, 33866547, 33866548, 33866549, 33866550, 33866551, 33866552,
        33866553, 33866554, 33866555, 33866556, 33866557, 33866558, 33866559, 33866560, 33866561,
        33866562, 33866563, 33866564, 33866565, 33866566, 33866567, 33866568, 33866569, 33866570,
        33866571, 33866572, 33866573, 33866574, 33866575, 33866576, 33866577, 33866578, 33866579,
        33866580, 33866581, 33866582, 33866583, 33866584, 33866585, 33866586, 33866587, 33866588,
        33866589, 33866590, 33866591, 33866592, 33866593, 33866594, 33866595, 33866596, 33866597,
        33866598, 33866599, 33866600, 33866601, 33866602, 33866603, 33866604, 33866605, 33866606,
        33866607, 33866608, 33866609, 33866610, 33866611, 33866612, 33866613, 33866614, 33866615,
        33866616, 33866617, 33866618, 33866619, 33866620, 33866621, 33866622, 33866623, 33866624,
        33866625, 33866626, 33866627, 33866628, 33866629, 33866630, 33866631, 33866632, 33866633,
        33866634, 33866635, 33866636, 33866637, 33866638, 33866639, 33866640, 33866641, 33866642,
        33866643, 33866644, 33866645, 33866646, 33866647, 33866648, 33866649, 33866650, 33866651,
        33866652, 33866653, 33866654, 33866655, 33866656, 33866657, 33866658, 33866659, 33866660,
        33866661, 33866662, 33866663, 33866664, 33866665, 33866666, 33866667, 33866668, 33866669,
        33866670, 33866671, 33866672, 33866673, 33866674, 33866675, 33866676, 33866677, 33866678,
        33866679, 33866680, 33866681, 33866682, 33866683, 33866684, 33866685, 33866686, 33866687,
        33866688, 33866689, 33866690, 33866691, 33866692, 33866693, 33866694, 33866695, 33866696,
        33866697, 33866698, 33866699, 33866700, 33866701, 33866702, 33866703, 33866704, 33866705,
        33866706, 33866707, 33866708, 33866709, 33866710, 33866711, 33866712, 33866713, 33866714,
        33866715, 33866716, 33866717, 33866718, 33866719, 33866720, 33866721, 33866722, 33866723,
        33866724, 33866725, 33866726, 33866727, 33866728, 33866729, 33866730, 33866731, 33866732,
        33866733, 33866734, 33866735, 33866736, 33866737, 33866738, 33866739, 33866740, 33866741,
        33866742, 33866743, 33866744, 33866745, 33866746, 33866747, 33866748, 33866749, 33866750,
        33866751, 33866752, 33866753, 33866754, 33866755, 33866756, 33866757, 33866758, 33866759,
        33866760, 33866761, 33866762, 33866763, 33866764, 33866765, 33866766, 33866767, 33866768,
        33866769, 33866770, 33866771, 33866772, 33866773, 33866774, 33866775, 33866776, 33866777,
        33866778, 33866779, 33866780, 33866781, 33866782, 33866783, 33866784, 33866785, 33866786,
        33866787, 33866788, 33866789, 33866790, 33866791, 33866792, 33866793, 33866794, 33866795,
        33866796, 33866797, 33866798, 33866799, 33866800, 33866801, 33866802, 33866803, 33866804,
        33866805, 33866806, 33866807, 33866808, 33866809, 33866810, 33866811, 33866812, 33866813,
        33866814, 33866815, 33866816, 33866817, 33866818, 33866819, 33866820, 33866821, 33866822,
        33866823, 33866824, 33866825, 33866826, 33866827, 33866828, 33866829, 33866830, 33866831,
        33866832, 33866833, 33866834, 33866835, 33866836, 33866837, 33866838, 33866839, 33866840,
        33866841, 33866842, 33866843, 33866844, 33866845, 33866846, 33866847, 33866848, 33866849,
        33866850, 33866851, 33866852, 33866853, 33866854, 33866855, 33866856, 33866857, 33866858,
        33866859, 33866860, 33866861, 33866862, 33866863, 33866864, 33866865, 33866866, 33866867,
        33866868, 33866869, 33866870, 33866871, 33866872, 33866873, 33866874, 33866875, 33866876,
        33866877, 33866878, 33866879, 33866880, 33866881, 33866882, 33866883, 33866884, 33866885,
        33866886, 33866887, 33866888, 33866889, 33866890, 33866891, 33866892, 33866893, 33866894,
        33866895, 33866896, 33866897, 33866898, 33866899, 33866900, 33866901, 33866902, 33866903,
        33866904, 33866905, 33866906, 33866907, 33866908, 33866909, 33866910, 33866911, 33866912,
        33866913, 33866914, 33866915, 33866916, 33866917, 33866918, 33866919, 33866920, 33866921,
        33866922, 33866923, 33866924, 33866925, 33866926, 33866927, 33866928, 33866929, 33866930,
        33866931, 33866932, 33866933, 33866934, 33866935, 33866936, 33866937, 33866938, 33866939,
        33866940, 33866941, 33866942, 33866943, 33866944, 33866945, 33866946, 33866947, 33866948,
        33866949, 33866950, 33866951, 33866952, 33866953, 33866954, 33866955, 33866956, 33866957,
        33866958, 33866959, 33866960, 33866961, 33866962, 33866963, 33866964, 33866965, 33866966,
        33866967, 33866968, 33866969, 33866970, 33866971, 33866972, 33866973, 33866974, 33866975,
        33866976, 33866977, 33866978, 33866979, 33866980, 33866981, 33866982, 33866983, 33866984,
        33866985, 33866986, 33866987, 33866988, 33866989, 33866990, 33866991, 33866992, 33866993,
        33866994, 33866995, 33866996, 33866997, 33866998, 33866999, 33867000, 33867001, 33867002,
        33867003, 33867004, 33867005, 33867006, 33867007, 33867008, 33867009, 33867010, 33867011,
        33867012, 33867013, 33867014, 33867015, 33867016, 33867017, 33867018, 33867019, 33867020,
        33867021, 33867022, 33867023, 33867024, 33867025, 33867026, 33867027, 33867028, 33867029,
        33867030, 33867031, 33867032, 33867033, 33867034, 33867035, 33867036, 33867037, 33867038,
        33867039, 33867040, 33867041, 33867042, 33867043, 33867044, 33867045, 33867046, 33867047,
        33867048, 33867049, 33867050, 33867051, 33867052, 33867053, 33867054, 33867055, 33867056,
        33867057, 33867058, 33867059, 33867060, 33867061, 33867062, 33867063, 33867064, 33867065,
        33867066, 33867067, 33867068, 33867069, 33867070, 33867071, 33867072, 33867073, 33867074,
        33867075, 33867076, 33867077, 33867078, 33867079, 33867080, 33867081, 33867082, 33867083,
        33867084, 33867085, 33867086, 33867087, 33867088, 33867089, 33867090, 33867091, 33867092,
        33867093, 33867094, 33867095, 33867096, 33867097, 33867098, 33867099, 33867100, 33867101,
        33867102, 33867103, 33867104, 33867105, 33867106, 33867107, 33867108, 33867109, 33867110,
        33867111, 33867112, 33867113, 33867114, 33867115, 33867116, 33867117, 33867118, 33867119,
        33867120, 33867121, 33867122, 33867123, 33867124, 33867125, 33867126, 33867127, 33867128,
        33867129, 33867130, 33867131, 33867132, 33867133, 33867134, 33867135, 33867136, 33867137,
        33867138, 33867139, 33867140, 33867141, 33867142, 33867143, 33867144, 33867145, 33867146,
        33867147, 33867148, 33867149, 33867150, 33867151, 33867152, 33867153, 33867154, 33867155,
        33867156, 33867157, 33867158, 33867159, 33867160, 33867161, 33867162, 33867163, 33867164,
        33867165, 33867166, 33867167, 33867168, 33867169, 33867170, 33867171, 33867172, 33867173,
        33867174, 33867175, 33867176, 33867177, 33867178, 33867179, 33867180, 33867181, 33867182,
        33867183, 33867184, 33867185, 33867186, 33867187, 33867188, 33867189, 33867190, 33867191,
        33867192, 33867193, 33867194, 33867195, 33867196, 33867197, 33867198, 33867199, 33867200,
        33867201, 33867202, 33867203, 33867204, 33867205, 33867206, 33867207, 33867208, 33867209,
        33867210, 33867211, 33867212, 33867213, 33867214, 33867215, 33867216, 33867217, 33867218,
        33867219, 33867220, 33867221, 33867222, 33867223, 33867224, 33867225, 33867226, 33867227,
        33867228, 33867229, 33867230, 33867231, 33867232, 33867233, 33867234, 33867235, 33867236,
        33867237, 33867238, 33867239, 33867240, 33867241, 33867242, 33867243, 33867244, 33867245,
        33867246, 33867247, 33867248, 33867249, 33867250, 33867251, 33867252, 33867253, 33867254,
        33867255, 33867256, 33867257, 33867258, 33867259, 33867260, 33867261, 33867262, 33867263,
        33867264, 33867265, 33867266, 33867267, 33867268, 33867269, 33867270, 33867271, 33867272,
        33867273, 33867274, 33867275, 33867276, 33867277, 33867278, 33867279, 33867280, 33867281,
        33867282, 33867283, 33867284, 33867285, 33867286, 33867287, 33867288, 33867289, 33867290,
        33867291, 33867292, 33867293, 33867294, 33867295, 33867296, 33867297, 33867298, 33867299,
        33867300, 33867301, 33867302, 33867303, 33867304, 33867305, 33867306, 33867307, 33867308,
        33867309, 33867310, 33867311, 33867312, 33867313, 33867314, 33867315, 33867316, 33867317,
        33867318, 33867319, 33867320, 33867321, 33867322, 33867323, 33867324, 33867325, 33867326,
        33867327, 33867328, 33867329, 33867330, 33867331, 33867332, 33867333, 33867334, 33867335,
        33867336, 33867337, 33867338, 33867339, 33867340, 33867341, 33867342, 33867343, 33867344,
        33867345, 33867346, 33867347, 33867348, 33867349, 33867350, 33867351, 33867352, 33867353,
        33867354, 33867355, 33867356, 33867357, 33867358, 33867359, 33867360, 33867361, 33867362,
        33867363, 33867364, 33867365, 33867366, 33867367, 33867368, 33867369, 33867370, 33867371,
        33867372, 33867373, 33867374, 33867375, 33867376, 33867377, 33867378, 33867379, 33867380,
        33867381, 33867382, 33867383, 33867384, 33867385, 33867386, 33867387, 33867388, 33867389,
        33867390, 33867391, 33867392, 33867393, 33867394, 33867395, 33867396, 33867397, 33867398,
        33867399, 33867400, 33867401, 33867402, 33867403, 33867404, 33867405, 33867406, 33867407,
        33867408, 33867409, 33867410, 33867411, 33867412, 33867413, 33867414, 33867415, 33867416,
        33867417, 33867418, 33867419, 33867420, 33867421, 33867422, 33867423, 33867424, 33867425,
        33867426, 33867427, 33867428, 33867429, 33867430, 33867431, 33867432, 33867433, 33867434,
        33867435, 33867436, 33867437, 33867438, 33867439, 33867440, 33867441, 33867442, 33867443,
        33867444, 33867445, 33867446, 33867447, 33867448, 33867449, 33867450, 33867451, 33867452,
        33867453, 33867454, 33867455, 33867456, 33867457, 33867458, 33867459, 33867460, 33867461,
        33867462, 33867463, 33867464, 33867465, 33867466, 33867467, 33867468, 33867469, 33867470,
        33867471, 33867472, 33867473, 33867474, 33867475, 33867476, 33867477, 33867478, 33867479,
        33867480, 33867481, 33867482, 33867483, 33867484, 33867485, 33867486, 33867487, 33867488,
        33867489, 33867490, 33867491, 33867492, 33867493, 33867494, 33867495, 33867496, 33867497,
        33867498, 33867499, 33867500, 33867501, 33867502, 33867503, 33867504, 33867505, 33867506,
        33867507, 33867508, 33867509, 33867510, 33867511, 33867512, 33867513, 33867514, 33867515,
        33867516, 33867517, 33867518, 33867519, 33867520, 33867521, 33867522, 33867523, 33867524,
        33867525, 33867526, 33867527, 33867528, 33867529, 33867530, 33867531, 33867532, 33867533,
        33867534, 33867535, 33867536, 33867537, 33867538, 33867539, 33867540, 33867541, 33867542,
        33867543, 33867544, 33867545, 33867546, 33867547, 33867548, 33867549, 33867550, 33867551,
        33867552, 33867553, 33867554, 33867555, 33867556, 33867557, 33867558, 33867559, 33867560,
        33867561, 33867562, 33867563, 33867564, 33867565, 33867566, 33867567, 33867568, 33867569,
        33867570, 33867571, 33867572, 33867573, 33867574, 33867575, 33867576, 33867577, 33867578,
        33867579, 33867580, 33867581, 33867582, 33867583, 33867584, 33867585, 33867586, 33867587,
        33867588, 33867589, 33867590, 33867591, 33867592, 33867593, 33867594, 33867595, 33867596,
        33867597, 33867598, 33867599, 33867600, 33867601, 33867602, 33867603, 33867604, 33867605,
        33867606, 33867607, 33867608, 33867609, 33867610, 33867611, 33867612, 33867613, 33867614,
        33867615, 33867616, 33867617, 33867618, 33867619, 33867620, 33867621, 33867622, 33867623,
        33867624, 33867625, 33867626, 33867627, 33867628, 33867629, 33867630, 33867631, 33867632,
        33867633, 33867634, 33867635, 33867636, 33867637, 33867638, 33867639, 33867640, 33867641,
        33867642, 33867643, 33867644, 33867645, 33867646, 33867647, 33867648, 33867649, 33867650,
        33867651, 33867652, 33867653, 33867654, 33867655, 33867656, 33867657, 33867658, 33867659,
        33867660, 33867661, 33867662, 33867663, 33867664, 33867665, 33867666, 33867667, 33867668,
        33867669, 33867670, 33867671, 33867672, 33867673, 33867674, 33867675, 33867676, 33867677,
        33867678, 33867679, 33867680, 33867681, 33867682, 33867683, 33867684, 33867685, 33867686,
        33867687, 33867688, 33867689, 33867690, 33867691, 33867692, 33867693, 33867694, 33867695,
        33867696, 33867697, 33867698, 33867699, 33867700, 33867701, 33867702, 33867703, 33867704,
        33867705, 33867706, 33867707, 33867708, 33867709, 33867710, 33867711, 33867712, 33867713,
        33867714, 33867715, 33867716, 33867717, 33867718, 33867719, 33867720, 33867721, 33867722,
        33867723, 33867724, 33867725, 33867726, 33867727, 33867728, 33867729, 33867730, 33867731,
        33867732, 33867733, 33867734, 33867735, 33867736, 33867737, 33867738, 33867739, 33867740,
        33867741, 33867742, 33867743, 33867744, 33867745, 33867746, 33867747, 33867748, 33867749,
        33867750, 33867751, 33867752, 33867753, 33867754, 33867755, 33867756, 33867757, 33867758,
        33867759, 33867760, 33867761, 33867762, 33867763, 33867764, 33867765, 33867766, 33867767,
        33867768, 33867769, 33867770, 33867771, 33867772, 33867773, 33867774, 33867775, 33867776,
        33867777, 33867778, 33867779, 33867780, 33867781, 33867782, 33867783, 33867784, 33867785,
        33867786, 33867787, 33867788, 33867789, 33867790, 33867791, 33867792, 33867793, 33867794,
        33867795, 33867796, 33867797, 33867798, 33867799, 33867800, 33867801, 33867802, 33867803,
        33867804, 33867805, 33867806, 33867807, 33867808, 33867809, 33867810, 33867811, 33867812,
        33867813, 33867814, 33867815, 33867816, 33867817, 33867818, 33867819, 33867820, 33867821,
        33867822, 33867823, 33867824, 33867825, 33867826, 33867827, 33867828, 33867829, 33867830,
        33867831, 33867832, 33867833, 33867834, 33867835, 33867836, 33867837, 33867838, 33867839,
        33867840, 33867841, 33867842, 33867843, 33867844, 33867845, 33867846, 33867847, 33867848,
        33867849, 33867850, 33867851, 33867852, 33867853, 33867854, 33867855, 33867856, 33867857,
        33867858, 33867859, 33867860, 33867861, 33867862, 33867863, 33867864, 33867865, 33867866,
        33867867, 33867868, 33867869, 33867870, 33867871, 33867872, 33867873, 33867874, 33867875,
        33867876, 33867877, 33867878, 33867879, 33867880, 33867881, 33867882, 33867883, 33867884,
        33867885, 33867886, 33867887, 33867888, 33867889, 33867890, 33867891, 33867892, 33867893,
        33867894, 33867895, 33867896, 33867897, 33867898, 33867899, 33867900, 33867901, 33867902,
        33867903, 33867904, 33867905, 33867906, 33867907, 33867908, 33867909, 33867910, 33867911,
        33867912, 33867913, 33867914, 33867915, 33867916, 33867917, 33867918, 33867919, 33867920,
        33867921, 33867922, 33867923, 33867924, 33867925, 33867926, 33867927, 33867928, 33867929,
        33867930, 33867931, 33867932, 33867933, 33867934, 33867935, 33867936, 33867937, 33867938,
        33867939, 33867940, 33867941, 33867942, 33867943, 33867944, 33867945, 33867946, 33867947,
        33867948, 33867949, 33867950, 33867951, 33867952, 33867953, 33867954, 33867955, 33867956,
        33867957, 33867958, 33867959, 33867960, 33867961, 33867962, 33867963, 33867964, 33867965,
        33867966, 33867967, 33867968, 33867969, 33867970, 33867971, 33867972, 33867973, 33867974,
        33867975, 33867976, 33867977, 33867978, 33867979, 33867980, 33867981, 33867982, 33867983,
        33867984, 33867985, 33867986, 33867987, 33867988, 33867989, 33867990, 33867991, 33867992,
        33867993, 33867994, 33867995, 33867996, 33867997, 33867998, 33867999, 33868000, 33868001,
        33868002, 33868003, 33868004, 33868005, 33868006, 33868007, 33868008, 33868009, 33868010,
        33868011, 33868012, 33868013, 33868014, 33868015, 33868016, 33868017, 33868018, 33868019,
        33868020, 33868021, 33868022, 33868023, 33868024, 33868025, 33868026, 33868027, 33868028,
        33868029, 33868030, 33868031, 33868032, 33868033, 33868034, 33868035, 33868036, 33868037,
        33868038, 33868039, 33868040, 33868041, 33868042, 33868043, 33868044, 33868045, 33868046,
        33868047, 33868048, 33868049, 33868050, 33868051, 33868052, 33868053, 33868054, 33868055,
        33868056, 33868057, 33868058, 33868059, 33868060, 33868061, 33868062, 33868063, 33868064,
        33868065, 33868066, 33868067, 33868068, 33868069, 33868070, 33868071, 33868072, 33868073,
        33868074, 33868075, 33868076, 33868077, 33868078, 33868079, 33868080, 33868081, 33868082,
        33868083, 33868084, 33868085, 33868086, 33868087, 33868088, 33868089, 33868090, 33868091,
        33868092, 33868093, 33868094, 33868095, 33868096, 33868097, 33868098, 33868099, 33868100,
        33868101, 33868102, 33868103, 33868104, 33868105, 33868106, 33868107, 33868108, 33868109,
        33868110, 33868111, 33868112, 33868113, 33868114, 33868115, 33868116, 33868117, 33868118,
        33868119, 33868120, 33868121, 33868122, 33868123, 33868124, 33868125, 33868126, 33868127,
        33868128, 33868129, 33868130, 33868131, 33868132, 33868133, 33868134, 33868135, 33868136,
        33868137, 33868138, 33868139, 33868140, 33868141, 33868142, 33868143, 33868144, 33868145,
        33868146, 33868147, 33868148, 33868149, 33868150, 33868151, 33868152, 33868153, 33868154,
        33868155, 33868156, 33868157, 33868158, 33868159, 33868160, 33868161, 33868162, 33868163,
        33868164, 33868165, 33868166, 33868167, 33868168, 33868169, 33868170, 33868171, 33868172,
        33868173, 33868174, 33868175, 33868176, 33868177, 33868178, 33868179, 33868180, 33868181,
        33868182, 33868183, 33868184, 33868185, 33868186, 33868187, 33868188, 33868189, 33868190,
        33868191, 33868192, 33868193, 33868194, 33868195, 33868196, 33868197, 33868198, 33868199,
        33868200, 33868201, 33868202, 33868203, 33868204, 33868205, 33868206, 33868207, 33868208,
        33868209, 33868210, 33868211, 33868212, 33868213, 33868214, 33868215, 33868216, 33868217,
        33868218, 33868219, 33868220, 33868221, 33868222, 33868223, 33868224, 33868225, 33868226,
        33868227, 33868228, 33868229, 33868230, 33868231, 33868232, 33868233, 33868234, 33868235,
        33868236, 33868237, 33868238, 33868239, 33868240, 33868241, 33868242, 33868243, 33868244,
        33868245, 33868246, 33868247, 33868248, 33868249, 33868250, 33868251, 33868252, 33868253,
        33868254, 33868255, 33868256, 33868257, 33868258, 33868259, 33868260, 33868261, 33868262,
        33868263, 33868264, 33868265, 33868266, 33868267, 33868268, 33868269, 33868270, 33868271,
        33868272, 33868273, 33868274, 33868275, 33868276, 33868277, 33868278, 33868279, 33868280,
        33868281, 33868282, 33868283, 33868284, 33868285, 33868286, 33868287, 33868288, 33868289,
        33868290, 33868291, 33868292, 33868293, 33868294, 33868295, 33868296, 33868297, 33868298,
        33868299, 33868300, 33868301, 33868302, 33868303, 33868304, 33868305, 33868306, 33868307,
        33868308, 33868309, 33868310, 33868311, 33868312, 33868313, 33868314, 33868315, 33868316,
        33868317, 33868318, 33868319, 33868320, 33868321, 33868322, 33868323, 33868324, 33868325,
        33868326, 33868327, 33868328, 33868329, 33868330, 33868331, 33868332, 33868333, 33868334,
        33868335, 33868336, 33868337, 33868338, 33868339, 33868340, 33868341, 33868342, 33868343,
        33868344, 33868345, 33868346, 33868347, 33868348, 33868349, 33868350, 33868351, 33868352,
        33868353, 33868354, 33868355, 33868356, 33868357, 33868358, 33868359, 33868360, 33868361,
        33868362, 33868363, 33868364, 33868365, 33868366, 33868367, 33868368, 33868369, 33868370,
        33868371, 33868372, 33868373, 33868374, 33868375, 33868376, 33868377, 33868378, 33868379,
        33868380, 33868381, 33868382, 33868383, 33868384, 33868385, 33868386, 33868387, 33868388,
        33868389, 33868390, 33868391, 33868392, 33868393, 33868394, 33868395, 33868396, 33868397,
        33868398, 33868399, 33868400, 33868401, 33868402, 33868403, 33868404, 33868405, 33868406,
        33868407, 33868408, 33868409, 33868410, 33868411, 33868412, 33868413, 33868414, 33868415,
        33868416, 33868417, 33868418, 33868419, 33868420, 33868421, 33868422, 33868423, 33868424,
        33868425, 33868426, 33868427, 33868428, 33868429, 33868430, 33868431, 33868432, 33868433,
        33868434, 33868435, 33868436, 33868437, 33868438, 33868439, 33868440, 33868441, 33868442,
        33868443, 33868444, 33868445, 33868446, 33868447, 33868448, 33868449, 33868450, 33868451,
        33868452, 33868453, 33868454, 33868455, 33868456, 33868457, 33868458, 33868459, 33868460,
        33868461, 33868462, 33868463, 33868464, 33868465, 33868466, 33868467, 33868468, 33868469,
        33868470, 33868471, 33868472, 33868473, 33868474, 33868475, 33868476, 33868477, 33868478,
        33868479, 33868480, 33868481, 33868482, 33868483, 33868484, 33868485, 33868486, 33868487,
        33868488, 33868489, 33868490, 33868491, 33868492, 33868493, 33868494, 33868495, 33868496,
        33868497, 33868498, 33868499, 33868500, 33868501, 33868502, 33868503, 33868504, 33868505,
        33868506, 33868507, 33868508, 33868509, 33868510, 33868511, 33868512, 33868513, 33868514,
        33868515, 33868516, 33868517, 33868518, 33868519, 33868520, 33868521, 33868522, 33868523,
        33868524, 33868525, 33868526, 33868527, 33868528, 33868529, 33868530, 33868531, 33868532,
        33868533, 33868534, 33868535, 33868536, 33868537, 33868538, 33868539, 33868540, 33868541,
        33868542, 33868543, 33868544, 33868545, 33868546, 33868547, 33868548, 33868549, 33868550,
        33868551, 33868552, 33868553, 33868554, 33868555, 33868556, 33868557, 33868558, 33868559,
        33868560, 33868561, 33868562, 33868563, 33868564, 33868565, 33868566, 33868567, 33868568,
        33868569, 33868570, 33868571, 33868572, 33868573, 33868574, 33868575, 33868576, 33868577,
        33868578, 33868579, 33868580, 33868581, 33868582, 33868583, 33868584, 33868585, 33868586,
        33868587, 33868588, 33868589, 33868590, 33868591, 33868592, 33868593, 33868594, 33868595,
        33868596, 33868597, 33868598, 33868599, 33868600, 33868601, 33868602, 33868603, 33868604,
        33868605, 33868606, 33868607, 33868608, 33868609, 33868610, 33868611, 33868612, 33868613,
        33868614, 33868615, 33868616, 33868617, 33868618, 33868619, 33868620, 33868621, 33868622,
        33868623, 33868624, 33868625, 33868626, 33868627, 33868628, 33868629, 33868630, 33868631,
        33868632, 33868633, 33868634, 33868635, 33868636, 33868637, 33868638, 33868639, 33868640,
        33868641, 33868642, 33868643, 33868644, 33868645, 33868646, 33868647, 33868648, 33868649,
        33868650, 33868651, 33868652, 33868653, 33868654, 33868655, 33868656, 33868657, 33868658,
        33868659, 33868660, 33868661, 33868662, 33868663, 33868664, 33868665, 33868666, 33868667,
        33868668, 33868669, 33868670, 33868671, 33868672, 33868673, 33868674, 33868675, 33868676,
        33868677, 33868678, 33868679, 33868680, 33868681, 33868682, 33868683, 33868684, 33868685,
        33868686, 33868687, 33868688, 33868689, 33868690, 33868691, 33868692, 33868693, 33868694,
        33868695, 33868696, 33868697, 33868698, 33868699, 33868700, 33868701, 33868702, 33868703,
        33868704, 33868705, 33868706, 33868707, 33868708, 33868709, 33868710, 33868711, 33868712,
        33868713, 33868714, 33868715, 33868716, 33868717, 33868718, 33868719, 33868720, 33868721,
        33868722, 33868723, 33868724, 33868725, 33868726, 33868727, 33868728, 33868729, 33868730,
        33868731, 33868732, 33868733, 33868734, 33868735, 33868736, 33868737, 33868738, 33868739,
        33868740, 33868741, 33868742, 33868743, 33868744, 33868745, 33868746, 33868747, 33868748,
        33868749, 33868750, 33868751, 33868752, 33868753, 33868754, 33868755, 33868756, 33868757,
        33868758, 33868759, 33868760, 33868761, 33868762, 33868763, 33868764, 33868765, 33868766,
        33868767, 33868768, 33868769, 33868770, 33868771, 33868772, 33868773, 33868774, 33868775,
        33868776, 33868777, 33868778, 33868779, 33868780, 33868781, 33868782, 33868783, 33868784,
        33868785, 33868786, 33868787, 33868788, 33868789, 33868790, 33868791, 33868792, 33868793,
        33868794, 33868795, 33868796, 33868797, 33868798, 33868799, 33868800, 33868801, 33868802,
        33868803, 33868804, 33868805, 33868806, 33868807, 33868808, 33868809, 33868810, 33868811,
        33868812, 33868813, 33868814, 33868815, 33868816, 33868817, 33868818, 33868819, 33868820,
        33868821, 33868822, 33868823, 33868824, 33868825, 33868826, 33868827, 33868828, 33868829,
        33868830, 33868831, 33868832, 33868833, 33868834, 33868835, 33868836, 33868837, 33868838,
        33868839, 33868840, 33868841, 33868842, 33868843, 33868844, 33868845, 33868846, 33868847,
        33868848, 33868849, 33868850, 33868851, 33868852, 33868853, 33868854, 33868855, 33868856,
        33868857, 33868858, 33868859, 33868860, 33868861, 33868862, 33868863, 33868864, 33868865,
        33868866, 33868867, 33868868, 33868869, 33868870, 33868871, 33868872, 33868873, 33868874,
        33868875, 33868876, 33868877, 33868878, 33868879, 33868880, 33868881, 33868882, 33868883,
        33868884, 33868885, 33868886, 33868887, 33868888, 33868889, 33868890, 33868891, 33868892,
        33868893, 33868894, 33868895, 33868896, 33868897, 33868898, 33868899, 33868900, 33868901,
        33868902, 33868903, 33868904, 33868905, 33868906, 33868907, 33868908, 33868909, 33868910,
        33868911, 33868912, 33868913, 33868914, 33868915, 33868916, 33868917, 33868918, 33868919,
        33868920, 33868921, 33868922, 33868923, 33868924, 33868925, 33868926, 33868927, 33868928,
        33868929, 33868930, 33868931, 33868932, 33868933, 33868934, 33868935, 33868936, 33868937,
        33868938, 33868939, 33868940, 33868941, 33868942, 33868943, 33868944, 33868945, 33868946,
        33868947, 33868948, 33868949, 33868950, 33868951, 33868952, 33868953, 33868954, 33868955,
        33868956, 33868957, 33868958, 33868959, 33868960, 33868961, 33868962, 33868963, 33868964,
        33868965, 33868966, 33868967, 33868968, 33868969, 33868970, 33868971, 33868972, 33868973,
        33868974, 33868975, 33868976, 33868977, 33868978, 33868979, 33868980, 33868981, 33868982,
        33868983, 33868984, 33868985, 33868986, 33868987, 33868988, 33868989, 33868990, 33868991,
        33868992, 33868993, 33868994, 33868995, 33868996, 33868997, 33868998, 33868999, 33869000,
        33869001, 33869002, 33869003, 33869004, 33869005, 33869006, 33869007, 33869008, 33869009,
        33869010, 33869011, 33869012, 33869013, 33869014, 33869015, 33869016, 33869017, 33869018,
        33869019, 33869020, 33869021, 33869022, 33869023, 33869024, 33869025, 33869026, 33869027,
        33869028, 33869029, 33869030, 33869031, 33869032, 33869033, 33869034, 33869035, 33869036,
        33869037, 33869038, 33869039, 33869040, 33869041, 33869042, 33869043, 33869044, 33869045,
        33869046, 33869047, 33869048, 33869049, 33869050, 33869051, 33869052, 33869053, 33869054,
        33869055, 33869056, 33869057, 33869058, 33869059, 33869060, 33869061, 33869062, 33869063,
        33869064, 33869065, 33869066, 33869067, 33869068, 33869069, 33869070, 33869071, 33869072,
        33869073, 33869074, 33869075, 33869076, 33869077, 33869078, 33869079, 33869080, 33869081,
        33869082, 33869083, 33869084, 33869085, 33869086, 33869087, 33869088, 33869089, 33869090,
        33869091, 33869092, 33869093, 33869094, 33869095, 33869096, 33869097, 33869098, 33869099,
        33869100, 33869101, 33869102, 33869103, 33869104, 33869105, 33869106, 33869107, 33869108,
        33869109, 33869110, 33869111, 33869112, 33869113, 33869114, 33869115, 33869116, 33869117,
        33869118, 33869119, 33869120, 33869121, 33869122, 33869123, 33869124, 33869125, 33869126,
        33869127, 33869128, 33869129, 33869130, 33869131, 33869132, 33869133, 33869134, 33869135,
        33869136, 33869137, 33869138, 33869139, 33869140, 33869141, 33869142, 33869143,
    ];

    let all_circuits = [
        BaseLayerCircuitType::VM,
        BaseLayerCircuitType::DecommitmentsFilter,
        BaseLayerCircuitType::Decommiter,
        BaseLayerCircuitType::LogDemultiplexer,
        BaseLayerCircuitType::KeccakPrecompile,
        BaseLayerCircuitType::Sha256Precompile,
        BaseLayerCircuitType::EcrecoverPrecompile,
        BaseLayerCircuitType::RamValidation,
        BaseLayerCircuitType::StorageFilter,
        BaseLayerCircuitType::StorageApplicator,
        BaseLayerCircuitType::EventsRevertsFilter,
        BaseLayerCircuitType::L1MessagesRevertsFilter,
        BaseLayerCircuitType::L1MessagesHasher,
        BaseLayerCircuitType::TransientStorageChecker,
        BaseLayerCircuitType::Secp256r1Verify,
        BaseLayerCircuitType::EIP4844Repack,
    ];

    let circuits = [BaseLayerCircuitType::VM];

    let mut amount = 0;
    for circuit_type in circuits {
        let key = AggregationsKey {
            block_number,
            circuit_id: get_recursive_layer_circuit_id_for_base_layer(circuit_type as u8),
            depth: 0,
        };

        /*
        let _ids = connection.fri_witness_generator_dal().prover_job_ids_for(
            block_number,
            circuit_type as u8,
            0.into(),
            0
        ).await;
        */

        let _ids = ids.clone();

        amount += _ids.len();
        if _ids.is_empty() {
            println!("{:?}: {}..{}, total: {}", circuit_type, 0, 0, 0);
        } else {
            println!(
                "{:?}: {}..{}, total: {}",
                circuit_type,
                _ids[0],
                _ids.last().unwrap(),
                _ids.len()
            );
        }

        let object_store_config = ObjectStoreConfig {
            mode: ObjectStoreMode::FileBacked {
                file_backed_base_path: "./tests/data/test_leaf/".to_owned(),
            },
            max_retries: 5,
            local_mirror_path: None,
        };

        let object_store = ObjectStoreFactory::new(object_store_config)
            .create_store()
            .await
            .unwrap();

        /*let expected_aggregation = object_store
        .get::<AggregationWrapper>(key)
        .await
        .expect("expected aggregation missing");*/
        let leaf_aggregation_job_metadata = LeafAggregationJobMetadata {
            id: 1,
            block_number,
            circuit_id: circuit_type as u8,
            prover_job_ids_for_proofs: _ids,
        };

        let job = prepare_leaf_aggregation_job(leaf_aggregation_job_metadata, &*object_store)
            .await
            .unwrap();

        let artifacts = LeafAggregationWitnessGenerator::process_job_impl(
            job,
            Instant::now(),
            object_store.clone(),
            100,
        )
        .await;

        snapshot_prof("BEFORE SAVE");
        save_artifacts(artifacts, &*object_store).await;
        snapshot_prof("AFTER SAVE");
    }

    println!("Total amount of proofs: {}", amount);

    //return;

    //let aggregations = AggregationWrapper(artifacts.aggregations);
    //compare_serialized(&expected_aggregation, &aggregations);
}

#[tokio::test]
async fn test_node_witness_gen() {
    let circuit_id = 3;
    let block_number = L1BatchNumber(11027);

    let proofs_ids_1 = vec![33869548, 33869549, 33869550];

    let proofs_ids = vec![
        33869461, 33869462, 33869463, 33869464, 33869465, 33869466, 33869467, 33869468, 33869469,
        33869470, 33869471, 33869472, 33869473, 33869474, 33869475, 33869476, 33869477, 33869478,
        33869479, 33869480, 33869481, 33869482, 33869483, 33869484, 33869485, 33869486, 33869487,
        33869488, 33869489, 33869490, 33869491, 33869492, 33869493, 33869494, 33869495, 33869496,
        33869497, 33869498, 33869499, 33869500, 33869501, 33869502, 33869503, 33869504, 33869505,
        33869506, 33869507, 33869508, 33869509, 33869510, 33869511, 33869512, 33869513, 33869514,
        33869515, 33869516, 33869517, 33869518, 33869519, 33869520, 33869521, 33869522, 33869523,
        33869524, 33869525, 33869526, 33869527, 33869528, 33869529, 33869530, 33869531, 33869532,
        33869533, 33869534, 33869535, 33869536, 33869537, 33869538, 33869539, 33869540, 33869541,
        33869542, 33869543, 33869544, 33869545, 33869546, 33869547,
    ];

    let proofs_ids_2 = vec![33869551];

    let object_store_config = ObjectStoreConfig {
        mode: ObjectStoreMode::FileBacked {
            file_backed_base_path: "./tests/data/test_leaf/".to_owned(),
        },
        max_retries: 5,
        local_mirror_path: None,
    };
    let object_store = ObjectStoreFactory::new(object_store_config)
        .create_store()
        .await
        .unwrap();

    let node_aggregation_job_metadata = NodeAggregationJobMetadata {
        id: 1,
        block_number,
        circuit_id,
        depth: 1,
        prover_job_ids_for_proofs: proofs_ids_1,
    };

    snapshot_prof("BEFORE");
    let job = node_aggregation::prepare_job(node_aggregation_job_metadata, &*object_store)
        .await
        .unwrap();

    let artifacts = NodeAggregationWitnessGenerator::process_job_impl(
        job,
        Instant::now(),
        object_store.clone(),
        500,
    )
    .await;
    snapshot_prof("AFTER");

    snapshot_prof("BEFORE SAVE");
    save_node_artifacts(artifacts, &*object_store).await;
    snapshot_prof("AFTER SAVE");
    //let aggregations = AggregationWrapper(artifacts.next_aggregations);
    //compare_serialized(&expected_aggregation, &aggregations);
}

#[tokio::test]
async fn test_basic_witness_gen() {
    let object_store_config = ObjectStoreConfig {
        mode: ObjectStoreMode::FileBacked {
            file_backed_base_path: "./tests/data/bwg/".to_owned(),
        },
        max_retries: 5,
        local_mirror_path: None,
    };
    let object_store = ObjectStoreFactory::new(object_store_config)
        .create_store()
        .await
        .unwrap();

    let block_number = L1BatchNumber(489509);

    let input = object_store.get(block_number).await.unwrap();

    let instant = Instant::now();

    //snapshot_prof("Before run");
    let (_circuit_urls, _queue_urls, _scheduler_witness, _aux_output_witness) =
        generate_witness(block_number, object_store, input, 500).await;
    //snapshot_prof("After run");
    println!("Generated witness, {:?}", instant.elapsed());
    //print_peak_mem_snapshots();
}
